# Example configuration for model choices and preprocessing pipeline.
# Conservative defaults for machines with ~32GB RAM/VRAM.
# Copy this file to `config/settings.yaml` and adjust as needed.
# The `./init_project.sh` script will also create a baseline
# `settings.yaml` if it does not exist.

models:
  embedding:
    backend: "siglip"
    model_name: "google/siglip2-base-patch16-224"
    device: "auto"           # "cuda", "mps", or "cpu"
    batch_size: 8            # smaller batch to cap memory per worker

  caption:
    backend: "blip"
    model_name: "Salesforce/blip-image-captioning-base"
    device: "auto"
    batch_size: 2

  detection:
    enabled: true
    backend: "owlvit"        # or "grounding-dino" in future milestones
    model_name: "google/owlvit-base-patch32"
    device: "auto"
    max_regions_per_image: 5
    score_threshold: 0.20
    # Class-agnostic non-max suppression for overlapping boxes.
    nms_iou_threshold: 0.8
    # Primary region priority weights (area + distance to center).
    primary_area_gamma: 0.3
    primary_center_penalty: 0.6
    # Caption-based primary region fallback.
    caption_primary_enabled: true
    caption_primary_min_priority: 0.02
    caption_primary_box_margin_x: 0.2
    caption_primary_box_margin_y: 0.1
    caption_primary_keywords:
      drink:
        label: "drink"
        keywords:
          - "drink"
          - "beverage"
          - "glass of"
          - "cocktail"
          - "juice"
          - "smoothie"
          - "coffee"
          - "tea"
          - "beer"
          - "wine"
          - "soda"
          - "soft drink"
    # Filter out low-priority secondary regions after sorting.
    secondary_min_priority: 0.03
    secondary_min_relative_to_primary: 0.3
    # SigLIP-based region re-ranking thresholds for per-region labels.
    # ``siglip_min_prob`` is the minimum probability required for the
    # top-1 label within its semantic group. ``siglip_min_margin`` is
    # the required gap between the best and second-best label within
    # that group. Regions that do not meet both thresholds keep only
    # the original detector label (no refined label is written).
    siglip_min_prob: 0.15
    siglip_min_margin: 0.05

  ocr:
    enabled: false           # M1 MUST work with OCR disabled

  # Shared SigLIP label dictionaries for region re-ranking, diagnostics,
  # and prototype detectors. Keeping these in configuration avoids
  # duplicating label lists across modules.
  siglip_labels:
    # Coarse semantic groups for SigLIP labels. Used as the single
    # source of truth for:
    #   - region re-ranking candidate labels,
    #   - mapping detector labels to semantic groups,
    #   - and SimpleDetector label prompts.
    # Downstream code flattens this mapping to build candidate label
    # lists and human-friendly category prompts.
    label_groups:
      food:
        - "food"
        - "tapas"
        - "pizza"
        - "burger"
        - "sushi"
        - "noodles"
        - "bread"
        - "dessert"
        - "cake"
        - "drink"
        - "butter"
        - "cheese"
        - "sauce"
        - "soup"
        - "beverage"
        - "glass of drink"
        - "cocktail"
        - "juice"
        - "coffee"
        - "tea"
        - "beer"
        - "wine"
        - "soft drink"
      electronics:
        - "phone"
        - "smartphone"
        - "iPhone"
        - "Android phone"
        - "computer"
        - "laptop"
        - "MacBook"
        - "tablet"
        - "iPad"
        - "headphones"
        - "AirPods"
        - "camera"
      document:
        - "document"
        - "book"
        - "notes"
      person:
        - "person"
        - "people"
      scene:
        - "landscape"
        - "architecture"
        - "building"
      animal:
        - "animal"
        - "pet"
      specific_products:
        - "iPhone"
        - "MacBook"
        - "iPad"
        - "AirPods"
        - "Samsung Galaxy"
        - "ThinkPad"
        - "Surface"

pipeline:
  # Whether to run detection step in M1.
  run_detection: false       # keep off by default for lower memory
  # Whether to skip heavy models for near-duplicates.
  skip_duplicates_for_heavy_models: true
  # Hamming distance threshold for near-duplicate grouping (default 12).
  phash_hamming_threshold: 12
  # Target thumbnail sizes (max width/height in pixels) for web previews.
  thumbnail_size_small: 256
  thumbnail_size_large: 1024
  # JPEG quality (1â€“100) for thumbnails.
  thumbnail_quality: 85
  # How to store EXIF datetime in the database: "raw" uses the original camera string;
  # "iso" normalizes to an ISO-8601-like "YYYY-MM-DDTHH:MM:SS" format when parsing succeeds.
  exif_datetime_format: "iso"

queues:
  broker_url: "redis://localhost:6379/0"
  result_backend: "redis://localhost:6379/1"
  preprocess_queue: "pre_process"
  main_queue: "process"
  post_process_queue: "post_process"
  default_concurrency: 1     # single-worker to avoid model duplication
  post_process_concurrency: 1
  backfill_batch_size: 128
